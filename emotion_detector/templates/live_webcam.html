<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Webcam Analysis - MoodSense</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #6C63FF;
            --happy: #FF6B6B;
            --neutral: #4ECDC4;
            --sad: #45B7D1;
            --dark: #2D3047;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 70px;
        }
        
        .navbar {
            background: var(--dark) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .nav-link {
            color: white !important;
            font-weight: 500;
        }
        
        .container-main {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        #webcam {
            width: 100%;
            border-radius: 15px;
            border: 3px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scaleX(-1); /* Mirror effect */
        }
        
        .emotion-badge {
            padding: 10px 15px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            margin: 5px;
            display: inline-block;
        }
        
        .emotion-badge.happy { background-color: var(--happy); }
        .emotion-badge.neutral { background-color: var(--neutral); }
        .emotion-badge.sad { background-color: var(--sad); }
        
        .recording-indicator {
            width: 15px;
            height: 15px;
            background-color: #ff0000;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .real-time-box {
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            background: #f8f9fa;
        }
        
        .btn-custom {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin: 5px;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3);
        }
        
        .btn-danger-custom {
            background: var(--happy);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-smile-beam me-2"></i> AI Emotion Detector
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i> Home
                </a>
                <a class="nav-link" href="/webcam">
                    <i class="fas fa-camera me-1"></i> Single Capture
                </a>
                <a class="nav-link active" href="/live-webcam">
                    <i class="fas fa-video me-1"></i> Live Analysis
                </a>
                <a class="nav-link" href="/history">
                    <i class="fas fa-history me-1"></i> History
                </a>
            </div>
        </div>
    </nav>

    <div class="container container-main">
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h2 class="fw-bold mb-2" style="color: var(--primary);">
                    <i class="fas fa-video me-2"></i> Real-time Live Analysis
                </h2>
                <p class="text-muted">Webcam continuously analyzes emotions without clicking any button</p>
            </div>
        </div>

        <div class="row g-4">
            <!-- Left: Webcam and Controls -->
            <div class="col-md-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-3">
                        <!-- Recording Status -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <span class="recording-indicator" id="recordingIndicator"></span>
                                <span class="fw-bold" id="recordingStatus">Live Analysis Active</span>
                            </div>
                            <div>
                                <span class="badge bg-primary" id="fpsCounter">0 FPS</span>
                                <span class="badge bg-success ms-2" id="analysisCounter">0 analyzed</span>
                            </div>
                        </div>
                        
                        <!-- Webcam Feed -->
                        <div class="position-relative">
                            <video id="webcam" autoplay playsinline></video>
                            <canvas id="overlayCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                        </div>
                        
                        <!-- Controls -->
                        <div class="text-center mt-3">
                            <button class="btn btn-custom" onclick="startWebcam()" id="startBtn">
                                <i class="fas fa-play me-2"></i> Start Live
                            </button>
                            <button class="btn btn-danger-custom" onclick="stopWebcam()" id="stopBtn">
                                <i class="fas fa-stop me-2"></i> Stop
                            </button>
                            <button class="btn btn-warning" onclick="toggleRecording()" id="recordBtn">
                                <i class="fas fa-circle me-2"></i> Record Video
                            </button>
                            <button class="btn btn-info" onclick="flipCamera()">
                                <i class="fas fa-sync-alt me-2"></i> Flip Camera
                            </button>
                        </div>
                        
                        <!-- Recording Info -->
                        <div class="mt-3 text-center" id="recordingInfo" style="display: none;">
                            <i class="fas fa-video me-2 text-danger"></i>
                            <span class="fw-bold text-danger">Recording...</span>
                            <span id="recordTime">00:00</span>
                            <button class="btn btn-sm btn-outline-danger ms-3" onclick="stopRecording()">
                                <i class="fas fa-stop me-1"></i> Stop Recording
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Results -->
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="fw-bold mb-3" style="color: var(--primary);">
                            <i class="fas fa-chart-line me-2"></i> Real-time Results
                        </h5>
                        
                        <!-- Current Emotion -->
                        <div class="real-time-box">
                            <h6 class="text-muted mb-2">Current Emotion:</h6>
                            <div id="currentEmotion" class="text-center">
                                <h1 id="emotionIcon" class="display-1">üòê</h1>
                                <h3 id="emotionText" class="fw-bold">Neutral</h3>
                                <div id="confidenceText" class="text-muted">Confidence: 0%</div>
                            </div>
                        </div>
                        
                        <!-- Emotion Statistics -->
                        <div class="mt-4">
                            <h6 class="fw-bold mb-3">Session Statistics:</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="emotion-badge happy">
                                        <div id="happyCount">0</div>
                                        <small>üòä Happy</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="emotion-badge neutral">
                                        <div id="neutralCount">0</div>
                                        <small>üòê Neutral</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="emotion-badge sad">
                                        <div id="sadCount">0</div>
                                        <small>üò¢ Sad</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Emotion Timeline -->
                        <div class="mt-4">
                            <h6 class="fw-bold mb-3">Recent Emotions:</h6>
                            <div id="emotionTimeline" style="max-height: 150px; overflow-y: auto;">
                                <div class="text-center text-muted py-3">
                                    No emotions detected yet
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3" style="color: var(--primary);">
                            <i class="fas fa-info-circle me-2"></i> How it works
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="bg-primary text-white rounded-circle p-2 me-3">
                                        <i class="fas fa-video"></i>
                                    </div>
                                    <div>
                                        <strong>Live Detection</strong><br>
                                        <small>Automatically analyzes face every 2 seconds</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="bg-success text-white rounded-circle p-2 me-3">
                                        <i class="fas fa-record-vinyl"></i>
                                    </div>
                                    <div>
                                        <strong>Video Recording</strong><br>
                                        <small>Click Record button to save video</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="bg-warning text-white rounded-circle p-2 me-3">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    <div>
                                        <strong>Real-time Stats</strong><br>
                                        <small>See emotion statistics live</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden canvas for processing -->
    <canvas id="processingCanvas" style="display: none;"></canvas>

    <script>
        // Global variables
        let stream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let recordStartTime = null;
        let recordInterval = null;
        let usingFrontCamera = true;
        let analysisInterval = null;
        let frameCount = 0;
        let lastFrameTime = Date.now();
        
        // Emotion statistics
        let emotionStats = {
            happy: 0,
            neutral: 0,
            sad: 0,
            total: 0
        };
        
        // Emotion timeline
        let emotionTimeline = [];
        
        // Start webcam
        async function startWebcam() {
            try {
                const constraints = {
                    video: {
                        facingMode: usingFrontCamera ? 'user' : 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('webcam');
                video.srcObject = stream;
                
                // Start real-time analysis
                startRealTimeAnalysis();
                
                // Enable buttons
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordBtn').disabled = false;
                document.getElementById('startBtn').disabled = true;
                
                showAlert('Live analysis started!', 'success');
            } catch (err) {
                console.error('Camera error:', err);
                showAlert('Camera access denied. Please check permissions.', 'danger');
            }
        }
        
        // Stop webcam
        function stopWebcam() {
            // Stop everything
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                document.getElementById('webcam').srcObject = null;
            }
            
            if (analysisInterval) {
                clearInterval(analysisInterval);
            }
            
            if (isRecording) {
                stopRecording();
            }
            
            // Reset UI
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('recordBtn').disabled = true;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('recordingInfo').style.display = 'none';
            
            showAlert('Live analysis stopped', 'info');
        }
        
        // Flip camera
        function flipCamera() {
            usingFrontCamera = !usingFrontCamera;
            stopWebcam();
            setTimeout(startWebcam, 500);
        }
        
        // Start real-time analysis
        function startRealTimeAnalysis() {
            // Clear any existing interval
            if (analysisInterval) {
                clearInterval(analysisInterval);
            }
            
            // Start analyzing every 2 seconds
            analysisInterval = setInterval(analyzeFrame, 2000);
            
            // Start FPS counter
            setInterval(updateFPSCounter, 1000);
        }
        
        // Analyze current frame
        async function analyzeFrame() {
            const video = document.getElementById('webcam');
            const canvas = document.getElementById('processingCanvas');
            const ctx = canvas.getContext('2d');
            
            if (!video.srcObject || video.videoWidth === 0) {
                return;
            }
            
            // Set canvas size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            ctx.save();
            ctx.scale(-1, 1); // Mirror for front camera
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();
            
            // Get image data
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            
            // Send to server for analysis
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'image_data=' + encodeURIComponent(imageData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.results && data.results.length > 0) {
                        const result = data.results[0];
                        
                        // Update current emotion display
                        updateEmotionDisplay(result);
                        
                        // Update statistics
                        updateStatistics(result.emotion);
                        
                        // Add to timeline
                        addToTimeline(result);
                        
                        // Draw face box on overlay
                        drawFaceBox(result);
                        
                        // Update counter
                        emotionStats.total++;
                        document.getElementById('analysisCounter').textContent = emotionStats.total + ' analyzed';
                    }
                }
            } catch (error) {
                console.error('Analysis error:', error);
            }
            
            // Update FPS
            frameCount++;
        }
        
        // Update emotion display
        function updateEmotionDisplay(result) {
            const emotionIcons = {
                'happy': 'üòä',
                'neutral': 'üòê',
                'sad': 'üò¢'
            };
            
            const emotionColors = {
                'happy': '#FF6B6B',
                'neutral': '#4ECDC4',
                'sad': '#45B7D1'
            };
            
            document.getElementById('emotionIcon').textContent = emotionIcons[result.emotion] || 'üòê';
            document.getElementById('emotionText').textContent = result.emotion.charAt(0).toUpperCase() + result.emotion.slice(1);
            document.getElementById('emotionText').style.color = emotionColors[result.emotion] || '#4ECDC4';
            document.getElementById('confidenceText').textContent = `Confidence: ${result.confidence.toFixed(1)}%`;
        }
        
        // Update statistics
        function updateStatistics(emotion) {
            if (emotionStats.hasOwnProperty(emotion)) {
                emotionStats[emotion]++;
                document.getElementById(emotion + 'Count').textContent = emotionStats[emotion];
            }
        }
        
        // Add emotion to timeline
        function addToTimeline(result) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const timelineItem = {
                time: timeStr,
                emotion: result.emotion,
                confidence: result.confidence,
                icon: result.emotion === 'happy' ? 'üòä' : result.emotion === 'sad' ? 'üò¢' : 'üòê',
                color: result.emotion === 'happy' ? '#FF6B6B' : result.emotion === 'sad' ? '#45B7D1' : '#4ECDC4'
            };
            
            emotionTimeline.unshift(timelineItem);
            
            // Keep only last 10 items
            if (emotionTimeline.length > 10) {
                emotionTimeline.pop();
            }
            
            // Update timeline display
            updateTimelineDisplay();
        }
        
        // Update timeline display
        function updateTimelineDisplay() {
            const timelineDiv = document.getElementById('emotionTimeline');
            timelineDiv.innerHTML = '';
            
            emotionTimeline.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'd-flex justify-content-between align-items-center mb-2 p-2';
                itemDiv.style.borderLeft = `4px solid ${item.color}`;
                itemDiv.style.background = '#f8f9fa';
                itemDiv.style.borderRadius = '5px';
                
                itemDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="me-2" style="font-size: 1.2rem;">${item.icon}</span>
                        <div>
                            <div class="fw-bold">${item.emotion.charAt(0).toUpperCase() + item.emotion.slice(1)}</div>
                            <small class="text-muted">${item.time}</small>
                        </div>
                    </div>
                    <div class="fw-bold">${item.confidence.toFixed(1)}%</div>
                `;
                
                timelineDiv.appendChild(itemDiv);
            });
        }
        
        // Draw face box on overlay
        function drawFaceBox(result) {
            const canvas = document.getElementById('overlayCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear previous drawings
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Set canvas size to match video
            const video = document.getElementById('webcam');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            if (result.position) {
                const colors = {
                    'happy': '#FF6B6B',
                    'neutral': '#4ECDC4',
                    'sad': '#45B7D1'
                };
                
                const x = result.position.x;
                const y = result.position.y;
                const w = result.position.w;
                const h = result.position.h;
                
                // Adjust for mirror effect
                const adjustedX = canvas.width - x - w;
                
                // Draw rectangle
                ctx.strokeStyle = colors[result.emotion] || '#4ECDC4';
                ctx.lineWidth = 3;
                ctx.strokeRect(adjustedX, y, w, h);
                
                // Draw label background
                ctx.fillStyle = colors[result.emotion] || '#4ECDC4';
                ctx.fillRect(adjustedX, y - 30, 80, 30);
                
                // Draw label text
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(
                    `${result.emotion.charAt(0).toUpperCase() + result.emotion.slice(1)}`,
                    adjustedX + 10,
                    y - 10
                );
            }
        }
        
        // Toggle recording
        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }
        
        // Start recording
        function startRecording() {
            if (!stream) {
                showAlert('Please start webcam first', 'warning');
                return;
            }
            
            recordedChunks = [];
            isRecording = true;
            
            // Create media recorder
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9'
            });
            
            // Collect data
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            // Save when stopped
            mediaRecorder.onstop = function() {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                
                // Create download link
                const a = document.createElement('a');
                a.href = url;
                a.download = `emotion_recording_${new Date().getTime()}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('Video saved!', 'success');
            };
            
            // Start recording
            mediaRecorder.start(1000); // Collect data every second
            
            // Start timer
            recordStartTime = Date.now();
            document.getElementById('recordingInfo').style.display = 'block';
            
            recordInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('recordTime').textContent = `${minutes}:${seconds}`;
            }, 1000);
            
            document.getElementById('recordBtn').innerHTML = '<i class="fas fa-stop-circle me-2"></i> Stop Recording';
            showAlert('Recording started', 'info');
        }
        
        // Stop recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                clearInterval(recordInterval);
                document.getElementById('recordingInfo').style.display = 'none';
                document.getElementById('recordBtn').innerHTML = '<i class="fas fa-circle me-2"></i> Record Video';
            }
        }
        
        // Update FPS counter
        function updateFPSCounter() {
            const now = Date.now();
            const elapsed = (now - lastFrameTime) / 1000;
            const fps = Math.round(frameCount / elapsed);
            
            document.getElementById('fpsCounter').textContent = `${fps} FPS`;
            
            // Reset counters
            frameCount = 0;
            lastFrameTime = now;
        }
        
        // Alert function
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 80px; right: 20px; z-index: 1050; max-width: 300px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-start webcam
            setTimeout(() => {
                startWebcam();
            }, 1000);
        });
    </script>
</body>
</html>